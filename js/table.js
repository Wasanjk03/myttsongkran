!function(){"use strict";window.GTable=GClass.create(),GTable.prototype={initialize:function(id,o){for(var prop in this.options={action:null,actionCallback:null,actionConfirm:null,onBeforeDelete:null,onDelete:null,onAddRow:null,onInitRow:null,pmButton:!1,dragColumn:-1},o)"debug"==prop&&""!=o.debug?console.log(o.debug):this.options[prop]=o[prop];this.table=$E(id),this.search=o.search||"",this.sort=o.sort||null,this.page=o.page||1,this.options.onAddRow&&(this.options.onAddRow=window[this.options.onAddRow],Object.isFunction(this.options.onAddRow)||(this.options.onAddRow=null)),this.options.onBeforeDelete&&(this.options.onBeforeDelete=window[this.options.onBeforeDelete],Object.isFunction(this.options.onBeforeDelete)||(this.options.onBeforeDelete=null)),this.options.onDelete&&(this.options.onDelete=window[this.options.onDelete],Object.isFunction(this.options.onDelete)||(this.options.onDelete=null)),this.options.onInitRow&&(this.options.onInitRow=window[this.options.onInitRow],Object.isFunction(this.options.onInitRow)||(this.options.onInitRow=null));var hs,sort_patt=/sort_(none|asc|desc)\s(col_([\w]+))(|\s.*)$/,action_patt=/button[\s][a-z]+[\s]action/,temp=this,_doSort=function(e){if(hs=sort_patt.exec(this.className)){var sort=new Array;if(GEvent.isCtrlKey(e)){var patt=new RegExp(hs[3]+"[\\s](asc|desc|none)");forEach(temp.sort.split(","),function(){patt.test(this)||sort.push(this)})}"none"==hs[1]?sort.push(hs[3]+"%20asc"):"asc"==hs[1]?sort.push(hs[3]+"%20desc"):sort.push(hs[3]+"%20none"),temp.sort=sort.join(","),window.location=temp.redirect()}};if(this.table){forEach($G(this.table).elems("th"),function(){sort_patt.test(this.className)&&callClick(this,_doSort)}),this.initTR(this.table),forEach(this.table.elems("tbody"),function(){temp.initTBODY(this,null)});var doAction=function(){var action="",cs=new Array,chk=/check_[0-9]+/;if(forEach(temp.table.elems("a"),function(){chk.test(this.id)&&$G(this).hasClass("icon-check")&&cs.push(this.id.replace("check_",""))}),0==cs.length)alert("กรุณาเลือก อย่างน้อย 1 รายการ");else{cs=cs.join(",");var f=this.get("for"),fn=window[temp.options.actionConfirm],t=$G(f).getText();t=t?t.strip_tags():null,Object.isFunction(fn)?action=fn(t,$E(f).value,cs):confirm("คุณต้องการ XXX รายการที่เลือก ?".replace(/XXX/,t))&&(action="module="+f+"&action="+$E(f).value+"&id="+cs),""!=action&&temp.callAction(this,action)}};forEach(this.table.elems("label"),function(){action_patt.test(this.className)&&callClick(this,doAction)}),this.options.dragColumn>-1&&new GSortTable(this.table,{endDrag:function(){var trs=new Array;forEach(temp.table.elems("tr"),function(){this.id&&trs.push(this.id.replace(id+"_",""))}),trs.length>1&&temp.callAction(this,"action=move&data="+trs.join(","))}})}forEach(this.table.elems("button"),function(){"clear_search"==this.className?(temp.clear_search=this,temp.input_search=this.parentNode.firstChild.firstChild,callClick(this,function(){temp.input_search.value=""})):""!=this.id&&callClick(this,function(){temp._doButton(this)})}),this.options.action&&window.setTimeout(function(){$E(temp.table)&&forEach(temp.table.elems("tbody"),function(){forEach(this.querySelectorAll("select,input,textarea"),function(){""!=this.id&&$G(this).addEvent("change",function(){temp._doButton(this)})})})},1e3);var doSearchChanged=function(){""==temp.input_search.value?temp.clear_search.style.display="none":temp.clear_search.style.display="block"};temp.input_search&&($G(temp.input_search).addEvent("change",doSearchChanged),doSearchChanged.call(temp)),"undefined"!=typeof loader&&forEach(this.table.querySelectorAll("form.table_nav"),function(){this.onsubmit=function(){var urls=this.action.split("?"),obj=new Object;if(urls[1]){forEach(urls[1].split("&"),function(){var hs=this.split("=");2==hs.length&&""!=hs[1]&&(obj[hs[0]]=hs[1])}),forEach(this.querySelectorAll("input,select"),function(){obj[this.name]=this.value});var q=new Array;for(var prop in obj)"search"==prop?q.push(prop+"="+encodeURIComponent(obj[prop])):"time"!=prop&&q.push(prop+"="+obj[prop]);q.push("time="+(new Date).getTime()),loader.setParams(q.join("&"))}return!1}})},callAction:function(el,action){var hs=this.options.action.split("?");hs[1]&&(action=hs[1]+"&"+action),action+="&src="+this.table.id,el.value&&(action+="&value="+encodeURIComponent(el.value));var temp=this;el.addClass("wait"),send(hs[0],action,function(xhr){if(el.removeClass("wait"),temp.options.actionCallback){var fn=window[temp.options.actionCallback];Object.isFunction(fn)&&fn(xhr)}else""!=xhr.responseText?alert(xhr.responseText):window.location.reload()})},_doButton:function(input){var action="",patt=/^([a-z_\-]+)_([0-9]+)(_([0-9]+))?$/,q=input.get("data-confirm");if(this.options.actionConfirm){var fn=window[this.options.actionConfirm],hs=patt.exec(input.id);if(hs&&Object.isFunction(fn)){var t=input.getText();action=fn(t=t?t.strip_tags():null,hs[1],hs[2],hs[4])}else action="action="+input.id}else q&&!confirm(q)||((hs=patt.exec(input.id))?"delete"==hs[1]?confirm("คุณต้องการ XXX ?".replace(/XXX/,"ลบ"))&&(action="action=delete&id="+hs[2]):action=hs[4]?"action="+hs[1]+"_"+hs[2]+"&id="+hs[4]:"action="+hs[1]+"&id="+hs[2]:action="action="+input.id);""!=action&&this.callAction(input,action)},initTBODY:function(tbody,tr){var row=0,temp=this;forEach($G(tbody).elems("tr"),function(){if(temp.options.pmButton&&(this.id=temp.table.id+"_"+row,forEach($G(this).elems("input"),function(){this.id=this.name.replace(/([\[\]_]+)/g,"_")+row})),(null===tr||tr===this)&&(temp.options.onInitRow&&temp.options.onInitRow.call(temp,this,row),temp.options.action)){var move=/(check|move)_([0-9]+)/;forEach($G(this).elems("a"),function(){var id=this.id;id&&!move.test(id)&&callClick(this,function(){temp._doButton(this)})})}row++})},initTR:function(el){var hs,a_patt=/(delete|icon)[_\-](plus|minus|[0-9]+)/,check_patt=/check_([0-9]+)/,temp=this,aClick=function(){var c=this.className;if("icon-plus"==c){var tr,tbody=(tr=$G(this.parentNode.parentNode.parentNode)).parentNode,ntr=tr.copy(!1);tr.after(ntr),temp.initTR(ntr),temp.options.onAddRow&&(ret=temp.options.onAddRow.call(temp,ntr)),temp.initTBODY(tbody,ntr),ntr.highlight(),(ntr=ntr.elems("input")[0])&&(ntr.focus(),ntr.select())}else if("icon-minus"==c){var tr=$G(this.parentNode.parentNode.parentNode),tbody=$G(tr.parentNode),ret=!0;temp.options.onBeforeDelete?ret=temp.options.onBeforeDelete.call(temp,tr):tbody.elems("tr").length>1&&(ret=confirm("คุณต้องการ XXX ?".replace(/XXX/,"ลบ"))),ret&&tbody.elems("tr").length>1&&(tr.remove(),temp.initTBODY(tbody,!1),temp.options.onDelete&&temp.options.onDelete.call(temp))}else if(hs=a_patt.exec(c)){var action="";"delete"==hs[1]&&confirm("คุณต้องการ XXX ?".replace(/XXX/,"ลบ"))&&(action="action=delete&id="+hs[2]),""!=action&&temp.options.action&&send(temp.options.action,action,function(xhr){var ds=xhr.responseText.toJSON();if(ds){if(ds.alert&&""!=ds.alert)alert(ds.alert);else if(ds.action&&"delete"==ds.action){var tr=$G(temp.table.id+"_"+ds.id),tbody=tr.parentNode;tr.remove(),temp.initTBODY(tbody,tr)}}else""!=xhr.responseText&&alert(xhr.responseText)},this)}},saClick=function(){this.focus();var chk=this.hasClass("icon-check");return forEach(el.elems("a"),function(){check_patt.test(this.id)?(this.className=chk?"icon-uncheck":"icon-check",this.title=chk?"เลือก":"ไม่เลือก"):this.hasClass("checkall")&&(this.className=chk?"checkall icon-uncheck":"checkall icon-check",this.title=chk?"เลือกทั้งหมด":"ไม่เลือก")}),!1},sClick=function(){this.focus();var chk=$G(this).hasClass("icon-check");return this.className=chk?"icon-uncheck":"icon-check",this.title=chk?"เลือก":"ไม่เลือก",forEach(el.elems("a"),function(){this.hasClass("checkall")&&(this.className="checkall icon-uncheck",this.title="เลือกทั้งหมด")}),!1};forEach($G(el).elems("a"),function(){a_patt.test(this.className)?callClick(this,aClick):$G(this).hasClass("checkall")?(this.title="เลือกทั้งหมด",callClick(this,saClick)):check_patt.test(this.id)&&(this.title="เลือก",callClick(this,sClick))})},setSort:function(sort,patt){var hs;forEach(this.table.elems("th"),function(){(hs=patt.exec(this.className))&&(sort==hs[2]?this.className=this.className.replace("sort_"+hs[1],"sort_"+("asc"==hs[1]?"desc":"asc")):this.className=this.className.replace("sort_"+hs[1],"sort_none"))})},redirect:function(){var hs,url="",patt=/^(.*)=(.*)$/,urls=new Object,u=window.location.href,us2=u.split("#"),us1=us2[0].split("?");2==us2.length?url=us2[1]:2==us1.length&&(url=us1[1]),""!=url&&forEach(url.split("&"),function(){(hs=patt.exec(this))?(hs[1]=hs[1].toLowerCase(),hs[2]=hs[2].toLowerCase(),"page"!=hs[1]&&"sort"!=hs[1]&&"search"!=hs[1]&&("action"!=hs[1]||"login"!=hs[2]&&"logout"!=hs[2])&&(urls[hs[1]]=this)):urls[this]=this});var us=Object.toArray(urls);return us.push("page="+this.page),this.sort&&us.push("sort="+this.sort),this.search&&us.push("search="+encodeURIComponent(this.search)),2==us2.length?(u=us2[0],us.length>0&&(u+="#"+us.join("&"))):(u=us1[0],us.length>0&&(u+="?"+us.join("&"))),u}}}();